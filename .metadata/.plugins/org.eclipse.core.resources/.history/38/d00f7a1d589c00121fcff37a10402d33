package ru.osm.dkiselev.atlasgenerator;

import java.awt.Graphics2D;
import java.awt.geom.Area;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;

import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;

import org.jdom.JDOMException;
import org.jopendocument.model.OpenDocument;
import org.jopendocument.renderer.ODTRenderer;
import org.odftoolkit.odfdom.dom.OdfContentDom;
import org.odftoolkit.odfdom.dom.attribute.text.TextAnchorTypeAttribute;
import org.odftoolkit.odfdom.dom.element.text.TextPElement;
import org.odftoolkit.odfdom.incubator.doc.draw.OdfDrawFrame;
import org.odftoolkit.odfdom.incubator.doc.draw.OdfDrawImage;
import org.odftoolkit.simple.TextDocument;
import org.w3c.dom.Node;

import com.deltaxml.odf.InvalidOdtFileException;
import com.deltaxml.odf.OdfLicensingException;
import com.deltaxml.odf.OdtInputException;
import com.deltaxml.odf.OdtOutputException;
import com.deltaxml.odf.StylesheetLoadException;
import com.deltaxml.odf.merge.NonExtendibleMergeResultException;
import com.deltaxml.odf.merge.OdtMerger;
import com.deltaxml.odf.merge.OdtMergerException;
import com.lowagie.text.Document;
import com.lowagie.text.DocumentException;
import com.lowagie.text.PageSize;
import com.lowagie.text.pdf.PdfContentByte;
import com.lowagie.text.pdf.PdfDocument;
import com.lowagie.text.pdf.PdfTemplate;
import com.lowagie.text.pdf.PdfWriter;

public class ODFGenerator {
	public static void main(String[] args) {
		
		String scale = args[1];
		String folder = args[0];
		
		TemplateParser template = new TemplateParser(Integer.valueOf(scale), new File(folder + "/map-page.ott"));
		
		try {
			
			template.parse();
			
			PolygonFileReader polygonFileReader = new PolygonFileReader(new File(args[2]));
			Area covereage = polygonFileReader.loadPolygon();
			GridGenerator gridGenerator = new GridGenerator(covereage);
			gridGenerator.generate(template.getScaledMapWidthM(), template.getScaledMapHeightM());
			
			MapRasterDataSource rds = new MapRasterDataSource(300, 
					"http://localhost/cgi-bin/qgis_mapserv.fcgi?map=/home/dkiselev/osm/walking-papers/bw.qgs",
					template.getWidthPX(), template.getHeightPX());
			
			List<File> pageDocs = new ArrayList<File>();
			for(GridCell c : gridGenerator.listCells() ) {
				byte[] content = rds.loadImage(c);
				
				TextDocument newDoc = insertImage(content, template, "map_page" + c.getPn() + ".png");
				
				newDoc.save(folder + "/page" + c.getPn() + ".odt");
				//convertToPDF(folder + "/page" + c.getPn() + ".odt", folder + "/page" + c.getPn() + ".pdf");
				
				pageDocs.add(new File(folder + "/page" + c.getPn() + ".odt"));
			}
			
			mergePages(pageDocs, folder + "/atlas.odf");
			
			for(File f : pageDocs) {
				f.delete(); 
			}
			
		} catch (Exception e) {
			e.printStackTrace();
		}
		
	}

//	private static void convertToPDF(String inPath, String outPath) throws DocumentException, FileNotFoundException {
//		final OpenDocument doc = new OpenDocument();
//		 doc.loadFrom(inPath);
//
//		 // Open the PDF document
//		 Document document = new com.lowagie.text.Document(PageSize.A4);
//		 File outFile = new File(outPath);
//
//		 PdfDocument pdf = new PdfDocument();
//
//		 document.addDocListener(pdf);
//
//		 FileOutputStream fileOutputStream = new FileOutputStream(outFile);
//		 PdfWriter writer = PdfWriter.getInstance(pdf, fileOutputStream);
//		 pdf.addWriter(writer);
//
//		 document.open();
//
//		 // Create a template and a Graphics2D object 
//		 com.lowagie.text.Rectangle pageSize = document.getPageSize();
//		 int w = (int) (pageSize.getWidth() * 0.9);
//		 int h = (int) (pageSize.getHeight() * 0.95);
//		 PdfContentByte cb = writer.getDirectContent();
//		 PdfTemplate tp = cb.createTemplate(w, h);
//
//		 Graphics2D g2 = tp.createPrinterGraphics(w, h, null);
//		 // If you want to prevent copy/paste, you can use
//		 // g2 = tp.createGraphicsShapes(w, h, true, 0.9f);
//		            
//		 tp.setWidth(w);
//		 tp.setHeight(h);
//
//		 // Configure the renderer
//		 ODTRenderer renderer = new ODTRenderer(doc);
//		 renderer.setIgnoreMargins(true);
//		 renderer.setPaintMaxResolution(true);
//		            
//		 // Scale the renderer to fit width
//		 renderer.setResizeFactor(renderer.getPrintWidth() / w);
//		 // Render
//		 renderer.paintComponent(g2);
//		 g2.dispose();
//
//		 // Add our spreadsheet in the middle of the page
//		 float offsetX = (float) ((pageSize.getWidth() - w) / 2);
//		 float offsetY = (float) ((pageSize.getHeight() - h) / 2);
//		 cb.addTemplate(tp, offsetX, offsetY);
//		 // Close the PDF document
//		 document.close();
//		 
//		 new File(inPath).delete();
//		
//	}
//
	private static void mergePages(List<File> pageDocs, String atlasFileName) throws Exception {
//		List<InputStream> pdfs = new ArrayList<InputStream>();
//		for(String path : pageDocs) {
//			pdfs.add(new FileInputStream(path));
//		}
//	    java.io.OutputStream output = new FileOutputStream(atlasFileName);
//	    MergePDF.concatPDFs(pdfs, output, true);
		
		
		
		OdtMerger merger = new OdtMerger();
		merger.merge(null, pageDocs, new File(atlasFileName));
	}

	/*
	 
	 <draw:frame draw:name="map_frame" draw:style-name="fr1"
		draw:z-index="0" svg:height="17.986cm" svg:width="16.222cm" svg:x="2.431cm"
		svg:y="2.78cm" text:anchor-page-number="1" text:anchor-type="page">
		<draw:text-box>
			<text:p text:style-name="Frame_20_contents">
				<draw:frame draw:name="graphics1" draw:style-name="fr5"
					draw:z-index="7" svg:height="17.655cm" svg:width="15.919cm"
					text:anchor-type="paragraph">
					<draw:image xlink:actuate="onLoad"
						xlink:href="Pictures/100000000000077B0000084C0845A435.png"
						xlink:show="embed" xlink:type="simple"></draw:image>
				</draw:frame>
			</text:p>
		</draw:text-box>
	 </draw:frame>
	 
	 */
	private static TextDocument insertImage(byte[] content, TemplateParser template, String imgName) throws Exception {
		
		template = template.withNewDocument();
		TextDocument newTextDocument = template.getDocument();
		
		OdfContentDom contentDom = newTextDocument.getContentDom();
		OdfDrawFrame drawFrame = contentDom.newOdfElement(OdfDrawFrame.class);
		
		XPath xpath = contentDom.getXPath();		
		Node mapFrame = template.getFrameByName().get(TemplateParser.MAP_FRAME);
		TextPElement lastPara = (TextPElement) xpath.evaluate("//text:p[last()]", mapFrame, XPathConstants.NODE);
		if (lastPara == null) {
			throw new RuntimeException("Map frame doesn't contains paragraph.");
		}
		lastPara.appendChild(drawFrame);

		drawFrame.setSvgWidthAttribute((template.getWidthMM() / 10) + "cm");
		drawFrame.setSvgHeightAttribute((template.getHeightMM() / 10) + "cm");
		drawFrame.setTextAnchorTypeAttribute(TextAnchorTypeAttribute.Value.PARAGRAPH.toString());
		drawFrame.setStyleRelHeightAttribute("100%");
		drawFrame.setStyleRelWidthAttribute("100%");

		OdfDrawImage image = (OdfDrawImage) drawFrame.newDrawImageElement();
		image.newImage(new ByteArrayInputStream(content), "Pictures/" + imgName, "image/png");
		
		return template.getDocument();
	}
}
